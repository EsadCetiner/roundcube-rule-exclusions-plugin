# Generic rule to disable plugin
SecRule TX:roundcube-rule-exclusions-plugin "@eq 0" "id:9519010,phase:1,pass,nolog,ctl:ruleRemoveById=9519100-9519999"

#
# [ Local CRS initialization ]
#
# We need to initialize some of the CRS variables also here because plugin setup runs before
# CRS initialization (this is a known limitation of the current plugin architecture). Must be
# kept in sync with CRS default setting.

# Copy of CRS rule 901162.
SecRule &TX:allowed_request_content_type "@eq 0" \
    "id:9519020,\
    phase:1,\
    pass,\
    nolog,\
    ver:'sogo-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'"


# Since Roundcube does everything within the same URL path, this plugin tries to improve code readability by creating seperate rules based
# upon what kind of false positives they fix.

# Fix RoundCube cookie false positive
# SecAction is used here instead of SecRule since Roundcube cookies are always sent regardless of if you are using Roundcube webmail or not.
SecAction \
    "id:9519100,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=942450;REQUEST_COOKIES:roundcube_sessid,\
    ctl:ruleRemoveTargetById=942450;REQUEST_COOKIES:roundcube_sessauth,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0'"

# When logging into Roundcube
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519101,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=921180;TX:paramcounter_ARGS_NAMES:_action,\
    ctl:ruleRemoveTargetById=921180;TX:paramcounter_ARGS_NAMES:_framed,\
    ctl:ruleRemoveTargetById=921180;TX:paramcounter_ARGS_NAMES:_task,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_pass,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0'"

# When changing passwords in Roundcube
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519102,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_confpasswd,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_newpasswd,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_curpasswd,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0'"

# When sending an email
# Composing an email in a new window
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519103,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule ARGS:_task "@streq mail" \
        "t:none,\
        chain"
        SecRule ARGS:_action "@rx ^(?:send|compose)$" \
            "t:none,\
            ctl:ruleRemoveTargetById=921110;REQUEST_BODY,\
            ctl:ruleRemoveTargetById=921180;TX:paramcounter_ARGS_NAMES:_id,\
            ctl:ruleRemoveTargetById=942131;ARGS:_to,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_message"

# When creating/modifying/searching contacts
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519104,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=931130;ARGS:_website[],\
    ctl:ruleRemoveTargetById=931130;ARGS:_search_website,\
    ctl:ruleRemoveTargetById=931130;ARGS:_im[],\
    ctl:ruleRemoveTargetById=931130;ARGS:_search_im,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0'"

# When viewing emails
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519105,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0'"

# When creating/modifying sieve filters
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519106,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_rule_target[0][],\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_rule_target[1][],\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_rule_target[2][],\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_rule_target[3][],\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_rule_target[4][],\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_rule_target[5][],\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_custom_var[0][],\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:rawsetcontent,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0'"

# When creating a signature to add at the end of emails
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519107,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:_signature,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0'"

# These rule exclusions are used for functions all over Roundcube
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519108,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=932131;REQUEST_HEADERS:referer,\
    ctl:ruleRemoveTargetById=932131;ARGS:_action_notifymethod[0],\
    ctl:ruleRemoveTargetById=932131;ARGS:_action_notifymethod[1],\
    ctl:ruleRemoveTargetById=932160;ARGS:r[0],\
    ctl:ruleRemoveTargetById=932200;ARGS:_action_notifymethod[0],\
    ctl:ruleRemoveTargetById=932200;ARGS:_action_notifymethod[1],\
    ctl:ruleRemoveTargetById=932236;ARGS:_action_notifymethod[0],\
    ctl:ruleRemoveTargetById=932236;ARGS:_action_notifymethod[1],\
    ctl:ruleRemoveTargetById=932236;ARGS:_action,\
    ctl:ruleRemoveTargetById=932236;ARGS:_task,\
    ctl:ruleRemoveTargetById=932236;ARGS:_section,\
    ctl:ruleRemoveTargetById=932239;REQUEST_HEADERS:referer,\
    ctl:ruleRemoveTargetById=932250;ARGS:_action,\
    ctl:ruleRemoveTargetById=932237;REQUEST_HEADERS:referer,\
    ctl:ruleRemoveTargetById=942131;ARGS:r[0],\
    ver:'roundcube-rule-exclusions-plugin/1.0.0'"

# If roundcube webmail sets a funny referrer then favicon will not load
SecRule REQUEST_FILENAME "@streq /favicon.ico" \
    "id:9519109,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=932131;REQUEST_HEADERS:referer,\
    ctl:ruleRemoveTargetById=932237;REQUEST_HEADERS:referer,\
    ctl:ruleRemoveTargetById=932239;REQUEST_HEADERS:referer,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0'"

# The text "Maximum allowed file size is 10 MB" in the response body triggers a FP with rule 953101.
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519110,\
    phase:4,\
    pass,\
    t:none,\
    nolog,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule RESPONSE_BODY "@rx maximum allowed file size is [0-9]+ [mg]b" \
        "t:none,\
        t:lowercase,\
        ctl:ruleRemoveById=953101"

# Deleting a sieve filter set
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519111,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule ARGS:_act "@streq setdel" \
        "t:none,\
        ctl:ruleRemoveTargetById=932236;ARGS:_act"

# Creating a sieve filter set from an existing filter set
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519112,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule ARGS:_from "@streq set" \
        "t:none,\
        ctl:ruleRemoveTargetById=932236;ARGS:_from"

# Composing an email in HTML mode
# Creating a signature in HTML mode
SecRule REQUEST_FILENAME "@beginsWith %{tx.roundcube-rule-exclusions-path}" \
    "id:9519113,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'roundcube-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule ARGS:_task "@streq utils" \
        "t:none,\
        chain"
        SecRule ARGS:_action "@rx ^(?:text2html|html2text)$" \
            "t:none,\
            setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |application/octet-stream|'"
